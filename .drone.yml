kind: pipeline
type: kubernetes
name: drone-demo-pipeline

trigger:
  ref:
    - refs/heads/main
    - refs/heads/**
    - refs/pull/*/head
steps:
  - name: Hello docker
    image: hello-world:latest
  - name: Maven test
    image: maven:3.9.0-eclipse-temurin-19
    commands:
      - mvn test
    depends_on:
      - Hello
  - name: Maven build
    image: maven:3.9.0-eclipse-temurin-19
    commands:
      - mvn clean package -DskipTests
    depends_on:
      - Hello
  - name: Build image and push
    image: gcr.io/kaniko-project/executor:v1.9.0-debug
    commands:
      - cp $DRONE_WORKSPACE/config.json /kaniko/.docker/
      - /kaniko/executor --dockerfile $DRONE_WORKSPACE/Dockerfile --context $DRONE_WORKSPACE --insecure --destination core.harbor.internal/openweb/drone-demo:0.1
    depends_on:
      - Maven test
      - Maven build

---
kind: pipeline
type: kubernetes
name: deploy-app

steps:
  - name: Deploy hello
    image: hello-world:latest

trigger:
  event:
    - promote
  target:
    - production